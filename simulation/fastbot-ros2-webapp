# Let's use "ubuntu:20.04" as the base of our image
FROM habartakh/habartakh-cp22:fastbot-ros2-slam

# Exporting a variable to install pkgs without any interactive questions
ENV DEBIAN_FRONTEND=noninteractive

# Installing nginx
RUN apt-get update \
    && apt-get install -y python3-pip  \
    python3-colcon-common-extensions \
    python3-setuptools \
    python3-pytest \
    python3-numpy \
    ros-humble-web-video-server \ 
    ros-humble-ament-cmake-mypy \ 
    && rm -rf /var/lib/apt/lists/*

# Install Python deps for rosbridge_suite
RUN pip install pymongo
RUN pip install tornado
RUN pip install pyquaternion

# Copying the local my_webpage to the docker image
COPY src/fastbot_ros2_docker/simulation/fastbot_webpage /webpage_ws/fastbot_webpage
# Copying the local entrypoint.sh file to /entrypoint.sh in the docker image
COPY src/fastbot_ros2_docker/simulation/entrypoint.sh /webpage_ws/fastbot_webpage/entrypoint.sh

# Clone the ROS Bridge suite in order to communicate with nodes from webpage
WORKDIR /ros2_ws/src
RUN git clone -b humble https://github.com/RobotWebTools/rosbridge_suite.git
# RUN git clone -b ros2 https://github.com/RobotWebTools/tf2_web_republisher.git 

# Build the Colcon workspace and ensure it's sourced
WORKDIR /ros2_ws
RUN source /opt/ros/humble/setup.bash \
 && cd /ros2_ws \
 && colcon build

RUN echo "source /ros2_ws/install/setup.bash" >> ~/.bashrc

WORKDIR /webpage_ws/fastbot_webpage/

# /bin/bash is the command we want to execute when running a docker container
ENTRYPOINT ["/bin/bash"]

# We want /bin/bash to execute our /entrypoint.sh when container starts
CMD ["/webpage_ws/fastbot_webpage/entrypoint.sh"]